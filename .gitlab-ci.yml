# GitLab Continuous Integration to build and deploy repository.
#
# For a reference of the CI file syntax, see
# https://docs.gitlab.com/ee/ci/yaml/.

# Workflow rules define whether or not the CI pipeline is run.
# The rules are required to ensure that every job is run for detached pipelines.
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH =~ /^.*$/

# Jobs of the same stage run in parallel. Jobs of the next stage only run after
# all current jobs have completed successfully.
stages:
  - build
  - deploy

# Contains settings that apply to all jobs unless overridden.
default:
  before_script:
    - python -m pip install --upgrade pip poetry setuptools wheel
    - poetry install

config:
  image: "node:16"
  stage: build
  before_script:
    - npm install -g prettier
  script:
    - prettier --check .

lint:
  image: "python:3.9"
  stage: build
  script:
    - poetry run bandit -ilr src/
    - poetry run black --check .
    - poetry run flake8 .
    - poetry run mypy --install-types --non-interactive .

test:
  image: "python:$version"
  stage: build
  parallel:
    matrix:
      - version: ["3.8", "3.9"]
  # pytest-postgresql uses pg_ctl to spin up temporary PostgreSQL databases.
  # pg_ctl will throw an error unless invoked as a non-root user.
  before_script:
    - apt-get update
    - apt-get install -y postgresql
    - useradd -lm -s /bin/bash pytest
    - python -m pip install --upgrade pip poetry setuptools wheel
    - su pytest -c 'poetry install'
  script:
    - su pytest -c 'poetry run pytest'

package:
  image: "python:3.9"
  stage: deploy
  script:
    - poetry build
    # Uploads packages as release files for Git tag.
  artifacts:
    paths:
      - dist/acronyms-$CI_COMMIT_TAG-py-none-any.whl
  # Makes the job only run on release commit tags, i.e. 1.0.4 or v0.4.1.
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+$/
      when: on_success
